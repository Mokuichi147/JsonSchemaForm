{% extends "base.html" %}
{% block content %}
<div class="flex flex-wrap items-center justify-between gap-3">
  <div>
    <h1 class="text-2xl font-semibold">{% if form %}フォーム編集{% else %}フォーム作成{% endif %}</h1>
    <p class="text-sm text-slate-600">ブロックを追加してフォームを構築します。</p>
  </div>
  {% if form %}
  <div class="flex flex-wrap gap-2 text-sm">
    <span class="rounded-full bg-slate-200 px-3 py-1">状態: {{ "公開" if form.status == "active" else "停止" }}</span>
    <a href="/f/{{ form.public_id }}" class="rounded border border-slate-300 px-3 py-1">入力ページ</a>
    <a href="/admin/forms/{{ form.id }}/submissions" class="rounded border border-slate-300 px-3 py-1">送信一覧</a>
  </div>
  {% endif %}
</div>

{% if errors %}
<div class="mt-4 rounded border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800">
  <ul class="list-disc pl-5">
    {% for error in errors %}
    <li>{{ error }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<form method="post" class="mt-6 space-y-6">
  <div class="rounded-lg border border-slate-200 bg-white p-5">
    <div class="grid gap-4 md:grid-cols-2">
      <div>
        <label class="text-sm font-semibold">フォーム名</label>
        <input name="name" value="{{ form.name if form else '' }}" class="mt-1 w-full rounded border border-slate-300 px-3 py-2" required />
      </div>
      <div>
        <label class="text-sm font-semibold">説明</label>
        <input name="description" value="{{ form.description if form else '' }}" class="mt-1 w-full rounded border border-slate-300 px-3 py-2" />
      </div>
    </div>
  </div>

  <div class="rounded-lg border border-slate-200 bg-white p-5">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <h2 class="text-lg font-semibold">フィールド</h2>
      <button type="button" id="add-field" class="rounded bg-slate-900 px-3 py-2 text-sm font-semibold text-white">フィールド追加</button>
    </div>
    <p class="mt-2 text-sm text-slate-600">キーは英字開始・英数字とアンダースコアのみ。並び替えはドラッグ操作。</p>

    <div id="field-list" class="mt-4 space-y-3"></div>
  </div>

  <input type="hidden" name="fields_json" id="fields_json" value="" />

  <div class="flex flex-wrap gap-3">
    <button type="submit" class="rounded bg-emerald-600 px-4 py-2 text-sm font-semibold text-white">保存</button>
    <a href="/admin/forms" class="rounded border border-slate-300 px-4 py-2 text-sm">戻る</a>
    {% if form %}
      {% if form.status == "active" %}
      <button formaction="/admin/forms/{{ form.id }}/stop" formmethod="post" class="rounded border border-slate-300 px-4 py-2 text-sm">停止</button>
      {% else %}
      <button formaction="/admin/forms/{{ form.id }}/publish" formmethod="post" class="rounded border border-slate-300 px-4 py-2 text-sm">公開</button>
      {% endif %}
    {% endif %}
  </div>
</form>

<template id="field-row-template">
  <div class="field-row rounded border border-slate-200 bg-slate-50 p-4">
    <div class="flex items-center justify-between">
      <div class="text-xs font-semibold text-slate-500">フィールド設定</div>
      <div class="flex items-center gap-2">
        <button type="button" data-action="remove" class="rounded border border-slate-300 px-2 py-1 text-xs">削除</button>
        <span class="drag-handle cursor-move text-xs text-slate-400">↕</span>
      </div>
    </div>
    <div class="mt-3 grid gap-3 md:grid-cols-4">
      <div class="md:col-span-1">
        <label class="text-xs text-slate-500">キー</label>
        <input data-field="key" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" placeholder="example_key" />
      </div>
      <div class="md:col-span-1">
        <label class="text-xs text-slate-500">ラベル</label>
        <input data-field="label" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" placeholder="表示名" />
      </div>
      <div>
        <label class="text-xs text-slate-500">種類</label>
        <select data-field="type" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm">
          <option value="string">文字列</option>
          <option value="number">数値</option>
          <option value="integer">整数</option>
          <option value="boolean">真偽</option>
          <option value="enum">選択肢</option>
          <option value="file">ファイル</option>
        </select>
      </div>
      <div class="flex items-center gap-2 pt-5 text-sm">
        <label class="flex items-center gap-2">
          <input type="checkbox" data-field="required" />
          必須
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" data-field="is_array" />
          配列
        </label>
      </div>
    </div>

    <div class="mt-3 grid gap-3 md:grid-cols-3">
      <div data-role="description">
        <label class="text-xs text-slate-500">説明</label>
        <input data-field="description" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" />
      </div>
      <div data-role="placeholder">
        <label class="text-xs text-slate-500">プレースホルダ</label>
        <input data-field="placeholder" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" />
      </div>
      <div data-role="format">
        <label class="text-xs text-slate-500">フォーマット</label>
        <select data-field="format" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm">
          <option value="">指定なし</option>
          <option value="email">email</option>
          <option value="date">date</option>
          <option value="url">url</option>
          <option value="datetime-local">datetime-local</option>
        </select>
      </div>
    </div>

    <div class="mt-3 grid gap-3 md:grid-cols-2">
      <div data-role="enum">
        <label class="text-xs text-slate-500">選択肢 (カンマ区切り)</label>
        <input data-field="enum" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" placeholder="A, B, C" />
      </div>
      <div data-role="minmax" class="grid grid-cols-2 gap-2">
        <div>
          <label class="text-xs text-slate-500">最小値</label>
          <input data-field="min" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="text-xs text-slate-500">最大値</label>
          <input data-field="max" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" />
        </div>
      </div>
    </div>
  </div>
</template>

<script id="fields-data" type="application/json">{{ fields_json | safe }}</script>
<script>
  const fieldList = document.getElementById("field-list");
  const template = document.getElementById("field-row-template");
  const addButton = document.getElementById("add-field");
  const fieldsInput = document.getElementById("fields_json");
  const initialFields = JSON.parse(document.getElementById("fields-data").textContent || "[]");

  const defaultField = {
    key: "",
    label: "",
    type: "string",
    required: false,
    description: "",
    placeholder: "",
    enum: [],
    min: "",
    max: "",
    format: "",
    is_array: false,
    items_type: "",
  };

  function normalizeField(raw) {
    const field = { ...defaultField, ...raw };
    if (!Array.isArray(field.enum)) {
      field.enum = [];
    }
    return field;
  }

  function setValue(row, name, value) {
    const el = row.querySelector(`[data-field="${name}"]`);
    if (!el) return;
    if (el.type === "checkbox") {
      el.checked = Boolean(value);
    } else {
      el.value = value ?? "";
    }
  }

  function applyVisibility(row) {
    const type = row.querySelector('[data-field="type"]').value;
    const isArray = row.querySelector('[data-field="is_array"]').checked;
    const showEnum = type === "enum";
    const showMinMax = type === "number" || type === "integer";
    const showFormat = type === "string";
    row.querySelector('[data-role="enum"]').classList.toggle("hidden", !showEnum);
    row.querySelector('[data-role="minmax"]').classList.toggle("hidden", !showMinMax);
    row.querySelector('[data-role="format"]').classList.toggle("hidden", !showFormat);
    row.querySelector('[data-role="placeholder"]').classList.toggle("hidden", !showFormat);

    if (isArray && type === "file") {
      row.querySelector('[data-role="format"]').classList.add("hidden");
      row.querySelector('[data-role="placeholder"]').classList.add("hidden");
    }
  }

  function readRow(row) {
    const get = (name) => row.querySelector(`[data-field="${name}"]`);
    const type = get("type").value;
    const isArray = get("is_array").checked;
    const enumRaw = get("enum").value || "";
    const enumValues = enumRaw
      .split(",")
      .map((value) => value.trim())
      .filter((value) => value.length > 0);

    return {
      key: get("key").value.trim(),
      label: get("label").value.trim(),
      type,
      required: get("required").checked,
      description: get("description").value.trim(),
      placeholder: get("placeholder").value.trim(),
      enum: enumValues,
      min: get("min").value.trim(),
      max: get("max").value.trim(),
      format: get("format").value,
      is_array: isArray,
      items_type: isArray ? type : "",
    };
  }

  function updateFieldsJson() {
    const rows = Array.from(fieldList.querySelectorAll(".field-row"));
    const fields = rows.map((row) => readRow(row));
    fieldsInput.value = JSON.stringify(fields);
  }

  function attachRowEvents(row) {
    row.querySelectorAll("input, select").forEach((input) => {
      input.addEventListener("change", () => {
        applyVisibility(row);
        updateFieldsJson();
      });
      input.addEventListener("input", () => {
        updateFieldsJson();
      });
    });
    row.querySelector('[data-action="remove"]').addEventListener("click", () => {
      row.remove();
      updateFieldsJson();
    });
    applyVisibility(row);
  }

  function addRow(field) {
    const row = template.content.firstElementChild.cloneNode(true);
    const normalized = normalizeField(field);
    setValue(row, "key", normalized.key);
    setValue(row, "label", normalized.label);
    setValue(row, "type", normalized.type);
    setValue(row, "required", normalized.required);
    setValue(row, "description", normalized.description);
    setValue(row, "placeholder", normalized.placeholder);
    setValue(row, "enum", (normalized.enum || []).join(", "));
    setValue(row, "min", normalized.min ?? "");
    setValue(row, "max", normalized.max ?? "");
    setValue(row, "format", normalized.format ?? "");
    setValue(row, "is_array", normalized.is_array);

    attachRowEvents(row);
    fieldList.appendChild(row);
  }

  addButton.addEventListener("click", () => {
    addRow(defaultField);
    updateFieldsJson();
  });

  if (initialFields.length > 0) {
    initialFields.forEach((field) => addRow(field));
  }

  updateFieldsJson();

  if (window.Sortable) {
    new Sortable(fieldList, {
      animation: 150,
      handle: ".drag-handle",
      onSort: updateFieldsJson,
    });
  }

  document.querySelector("form").addEventListener("submit", () => {
    updateFieldsJson();
  });
</script>
{% endblock %}
